name: ChatLaLiLuLeLo CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  # Logging Configuration - Set to 'true' to enable detailed logging
  ENABLE_DEBUG_LOGS: 'true'
  ENABLE_BUILD_LOGS: 'true'
  ENABLE_TEST_LOGS: 'true'
  # Log retention settings
  LOG_RETENTION_DAYS: 30
  # NPM/Node logging levels
  NPM_LOG_LEVEL: 'info'  # silent, error, warn, info, verbose, silly

jobs:
  test-and-lint:
    name: Test, Lint & Build
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“Š Environment Info
        if: env.ENABLE_DEBUG_LOGS == 'true'
        run: |
          echo "ğŸ”§ CI Environment Information:"
          echo "Node Version: ${{ matrix.node-version }}"
          echo "Runner OS: ${{ runner.os }}"
          echo "GitHub Ref: ${{ github.ref }}"
          echo "GitHub SHA: ${{ github.sha }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Job: ${{ github.job }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“‹ System Dependencies Info
        if: env.ENABLE_DEBUG_LOGS == 'true'
        run: |
          echo "ğŸ”§ System Information:"
          node --version
          npm --version
          echo "NPM Cache Location: $(npm config get cache)"
          echo "Working Directory: $(pwd)"
          echo "Available Disk Space:"
          df -h || true
          echo ""

      - name: ğŸ“¦ Install root dependencies
        run: |
          echo "ğŸ“¦ Installing root dependencies..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm ci --loglevel=${{ env.NPM_LOG_LEVEL }}
          else
            npm ci --silent
          fi
          echo "âœ… Root dependencies installed successfully"

      - name: ğŸ“¦ Install mobile app dependencies  
        run: |
          cd apps/mobile
          echo "ğŸ“¦ Installing mobile app dependencies..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm ci --loglevel=${{ env.NPM_LOG_LEVEL }}
          else
            npm ci --silent
          fi
          echo "âœ… Mobile app dependencies installed successfully"

      - name: ğŸ“‹ Generate dependency info
        if: env.ENABLE_DEBUG_LOGS == 'true'
        run: |
          cd apps/mobile
          echo "ğŸ“‹ Dependency Information:"
          echo "Package.json dependencies:"
          npm list --depth=0 --json > dependency-info.json
          cat dependency-info.json | jq '.dependencies | keys[]' 2>/dev/null || echo "jq not available"
          echo "Total packages: $(cat dependency-info.json | jq '.dependencies | length' 2>/dev/null || echo 'unknown')"
          du -sh node_modules 2>/dev/null || echo "Could not get node_modules size"
          echo ""

      - name: ğŸ§ª Run local CI tests
        run: |
          echo "ğŸ§ª Running ChatLaLiLuLeLo CI validation..."
          # Note: Skip API key checks in GitHub Actions (no .dev.vars file)
          node scripts/test-ci.js || {
            echo "âŒ CI validation failed"
            exit 1
          }
          echo "âœ… CI validation completed successfully"

      - name: ğŸ” TypeScript check
        run: |
          echo "ğŸ” Running TypeScript compilation check..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm run typecheck 2>&1 | tee apps/mobile/typescript-check.log
          else
            npm run typecheck
          fi
          echo "âœ… TypeScript check completed successfully"

      - name: ğŸ›¡ï¸ Lint code
        run: |
          echo "ğŸ›¡ï¸ Running ESLint code quality check..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm run lint 2>&1 | tee apps/mobile/eslint.log
          else
            npm run lint
          fi
          echo "âœ… Code linting completed successfully"
          
      - name: ğŸ“± Validate mobile assets
        run: |
          echo "ğŸ“± Validating mobile app assets and configuration..."
          cd apps/mobile
          
          # Check for required asset directories
          if [ -d "assets/audio" ]; then
            echo "âœ… Audio assets directory found"
            audio_count=$(find assets/audio -name "*.mp3" | wc -l)
            echo "ğŸ“Š Found $audio_count MP3 audio files"
            if [ $audio_count -lt 5 ]; then
              echo "âš ï¸  Warning: Expected at least 5 audio files for codec sounds"
            fi
          else
            echo "âŒ Audio assets directory missing!"
            exit 1
          fi
          
          # Check for critical components
          required_components=(
            "src/components/CodecStandby.tsx"
            "src/components/StartupAnimation.tsx" 
            "src/features/chat/ChatScreen.tsx"
            "src/lib/audio.ts"
            "src/lib/theme.ts"
          )
          
          for component in "${required_components[@]}"; do
            if [ -f "$component" ]; then
              echo "âœ… $component found"
            else
              echo "âŒ Missing critical component: $component"
              exit 1
            fi
          done
          
          echo "âœ… Mobile assets and components validated"

      - name: ğŸ§ª Run tests
        run: |
          cd apps/mobile
          echo "ğŸ§ª Running Jest test suite..."
          if [ "${{ env.ENABLE_TEST_LOGS }}" == "true" ]; then
            npm test -- --coverage --passWithNoTests --verbose 2>&1 | tee test-results.log
          else
            npm test -- --coverage --passWithNoTests --silent
          fi
          echo "âœ… Tests completed successfully"

      - name: ğŸ  Build for production
        run: |
          cd apps/mobile
          echo "ğŸ  Building production web bundle..."
          if [ "${{ env.ENABLE_BUILD_LOGS }}" == "true" ]; then
            npx expo export --platform web 2>&1 | tee build.log
            echo "ğŸ“‹ Build output details:"
            ls -la dist/ 2>/dev/null || echo "No dist directory"
            find dist/ -type f -exec ls -lh {} \; 2>/dev/null || echo "No files to list"
          else
            npx expo export --platform web
          fi
          echo "âœ… Production build completed successfully"

      - name: ğŸ“¤ Save build logs
        uses: actions/upload-artifact@v4
        if: env.ENABLE_DEBUG_LOGS == 'true' && matrix.node-version == '20.x'
        with:
          name: build-logs-${{ matrix.node-version }}
          path: |
            apps/mobile/typescript-check.log
            apps/mobile/eslint.log
            apps/mobile/test-results.log
            apps/mobile/build.log
            apps/mobile/dependency-info.json
          retention-days: ${{ fromJson(env.LOG_RETENTION_DAYS) }}
          if-no-files-found: ignore

      - name: Upload test coverage
        uses: codecov/codecov-action@v4
        if: matrix.node-version == '20.x'
        with:
          file: ./apps/mobile/coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”’ Setup Node.js for security scan
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ”’ Install dependencies for audit
        run: |
          cd apps/mobile
          npm ci --silent

      - name: ğŸ” Run security audit
        run: |
          cd apps/mobile
          echo "ğŸ” Running security audit..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm audit --audit-level moderate 2>&1 | tee security-audit.log
            echo "ğŸ“‹ Security audit summary:"
            npm audit --audit-level moderate --json > security-report.json 2>/dev/null || echo "JSON report failed"
          else
            npm audit --audit-level moderate
          fi
          echo "âœ… Security audit completed successfully"

      - name: ğŸ“¤ Save security logs
        uses: actions/upload-artifact@v4
        if: env.ENABLE_DEBUG_LOGS == 'true'
        with:
          name: security-logs
          path: |
            apps/mobile/security-audit.log
            apps/mobile/security-report.json
          retention-days: ${{ fromJson(env.LOG_RETENTION_DAYS) }}
          if-no-files-found: ignore

  validate-demo:
    name: Validate Demo Build
    runs-on: ubuntu-latest
    needs: [test-and-lint]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ğŸ  Setup Node.js for demo build
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies for demo
        run: |
          echo "ğŸ“¦ Installing dependencies for demo build..."
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            npm ci --loglevel=${{ env.NPM_LOG_LEVEL }}
            cd apps/mobile
            npm ci --loglevel=${{ env.NPM_LOG_LEVEL }}
          else
            npm ci --silent
            cd apps/mobile
            npm ci --silent
          fi
          echo "âœ… Demo dependencies installed successfully"

      - name: ğŸ  Build web demo
        run: |
          cd apps/mobile
          echo "ğŸ  Building web demo for validation..."
          if [ "${{ env.ENABLE_BUILD_LOGS }}" == "true" ]; then
            npx expo export --platform web 2>&1 | tee demo-build.log
          else
            npx expo export --platform web
          fi
          echo "âœ… Demo build completed successfully"
          
      - name: ğŸ” Validate build output
        run: |
          cd apps/mobile
          echo "ğŸ” Validating build artifacts..."
          
          # Check if dist directory exists
          if [ -d "dist" ]; then
            echo "âœ… Build directory 'dist' found"
            
            # List contents with details
            echo "ğŸ“‹ Build contents:"
            ls -la dist/
            
            # Check for required files
            if [ -f "dist/index.html" ]; then
              echo "âœ… index.html found"
              if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
                echo "File size: $(du -h dist/index.html | cut -f1)"
              fi
            else
              echo "âŒ index.html missing!"
              exit 1
            fi
            
            # Check bundle size
            if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
              echo "ğŸ“‹ Bundle analysis:"
              find dist/ -name "*.js" -exec ls -lh {} \;
              echo "Total build size: $(du -sh dist/ | cut -f1)"
            fi
            
            # Save build manifest
            find dist/ -type f > build-manifest.txt
            echo "ğŸ“‹ Build manifest saved ($(wc -l < build-manifest.txt) files)"
            
          else
            echo "âŒ No dist directory found!"
            echo "ğŸ” Searching for build output..."
            find . -name "dist" -type d 2>/dev/null || echo "No dist directory anywhere"
            exit 1
          fi
          
      - name: ğŸ“¤ Save demo logs
        uses: actions/upload-artifact@v4
        if: env.ENABLE_DEBUG_LOGS == 'true'
        with:
          name: demo-logs
          path: |
            apps/mobile/demo-build.log
            apps/mobile/build-manifest.txt
          retention-days: ${{ fromJson(env.LOG_RETENTION_DAYS) }}
          if-no-files-found: ignore
          
      - name: ğŸ“¤ Upload demo artifacts
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: web-build
          path: apps/mobile/dist/
          retention-days: 7
          if-no-files-found: error

  notify-status:
    name: ğŸ“Š Final Status & Log Summary  
    runs-on: ubuntu-latest
    needs: [test-and-lint, security-scan, validate-demo]
    if: always()
    
    steps:
      - name: ğŸ“‹ Generate comprehensive status report
        run: |
          echo "ğŸ“‹ ========================================"
          echo "ğŸ“‹     ChatLaLiLuLeLo CI/CD Summary"
          echo "ğŸ“‹ ========================================"
          echo "Workflow Run: #${{ github.run_number }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo ""
          
          # Job Results Summary
          echo "ğŸ“‹ Job Results:"
          echo "  ğŸ§ª Test & Lint (Node 18.x/20.x): ${{ needs.test-and-lint.result }}"
          echo "  ğŸ”’ Security Scan: ${{ needs.security-scan.result }}"
          echo "  ğŸ  Demo Build Validation: ${{ needs.validate-demo.result }}"
          echo ""
          
          # Logging Configuration Status
          echo "ğŸ“‹ Logging Configuration:"
          echo "  Debug Logs: ${{ env.ENABLE_DEBUG_LOGS }}"
          echo "  Build Logs: ${{ env.ENABLE_BUILD_LOGS }}"
          echo "  Test Logs: ${{ env.ENABLE_TEST_LOGS }}"
          echo "  Log Retention: ${{ env.LOG_RETENTION_DAYS }} days"
          echo ""
          
          # Overall Status
          if [ "${{ needs.test-and-lint.result }}" == "success" ] && 
             [ "${{ needs.security-scan.result }}" == "success" ] && 
             [ "${{ needs.validate-demo.result }}" == "success" ]; then
            echo "âœ… ========================================"
            echo "âœ…        ALL SYSTEMS OPERATIONAL"
            echo "âœ…   ChatLaLiLuLeLo is ready for deployment!"
            echo "âœ… ========================================"
            echo "CODEC_STATUS=OPERATIONAL" >> $GITHUB_ENV
          else
            echo "âŒ ========================================"
            echo "âŒ          SYSTEM MALFUNCTION"
            echo "âŒ      Some checks failed - review logs"
            echo "âŒ ========================================"
            echo "CODEC_STATUS=MALFUNCTION" >> $GITHUB_ENV
          fi
          
          # Available Artifacts
          echo ""
          echo "ğŸ“¦ Available Artifacts (if logging enabled):"
          if [ "${{ env.ENABLE_DEBUG_LOGS }}" == "true" ]; then
            echo "  ğŸ“¤ build-logs-20.x (Build process logs)"
            echo "  ğŸ“¤ security-logs (Security audit results)"
            echo "  ğŸ“¤ demo-logs (Demo build validation)"
          fi
          echo "  ğŸ  web-build (Deployable web demo)"
          echo ""
          echo "ğŸ“‹ Log artifacts retained for ${{ env.LOG_RETENTION_DAYS }} days"
          echo "ğŸ“‹ To disable detailed logging, set ENABLE_*_LOGS to 'false'"
          echo "========================================"
